(function(window){
  function $(selector){
    var els = typeof selector === 'string' ? document.querySelectorAll(selector) : [selector];
    var wrapper = Array.prototype.slice.call(els);
    wrapper.each = function(fn){ wrapper.forEach(fn); return wrapper; };
    wrapper.on = function(event, fn){ wrapper.forEach(function(el){ el.addEventListener(event, fn); }); return wrapper; };
    wrapper.val = function(v){ if (v===undefined) { return wrapper[0] && wrapper[0].value; } wrapper.forEach(function(el){ el.value = v; }); return wrapper; };
    wrapper.DataTable = function(){ return { destroy:function(){}, draw:function(){} }; };
    wrapper.select2 = function(opts){
      if (opts && opts.ajax && opts.ajax.url){
        var url = opts.ajax.url;
        var process = opts.processResults || function(d){ return { results: d }; };
        fetch(url).then(function(r){ return r.json(); }).then(function(data){
          var results = (process(data).results)||[];
          wrapper.forEach(function(el){
            if (el.tagName && el.tagName.toLowerCase() === 'select'){
              el.innerHTML = '';
              results.forEach(function(it){ var o = document.createElement('option'); o.value = it.id; o.text = it.text; el.appendChild(o); });
            }
          });
        }).catch(function(){ /* ignore */ });
      }
      return wrapper;
    };
    return wrapper;
  }
  window.$ = window.jQuery = $;
})(window);
